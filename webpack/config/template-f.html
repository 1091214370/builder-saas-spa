<%
  const { assets_url, heads, bodies, pages, debug } = htmlWebpackPlugin.options
  const version = '?v=' + (+ new Date())
%>
<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="format-detection" content="email=no" />
  <% for(let i = 0; i < heads.length; i++) { %>
  <%= heads[i] %>
  <% } %>
  <link rel="preload" href="https://gw.alipayobjects.com/os/lib/react/16.8.6/umd/react.production.min.js" as="script">
  <link rel="preload" href="https://gw.alipayobjects.com/os/lib/react-dom/16.8.6/umd/react-dom.production.min.js" as="script">
  <script src="https://gw.alipayobjects.com/as/g/component/babel-polyfill/6.20.0/polyfill.min.js"></script>
  <script src="https://gw.alipayobjects.com/os/lib/single-spa/4.3.5/lib/umd/single-spa.min.js"></script>
  <script src="https://gw.alipayobjects.com/os/lib/systemjs/4.0.0/dist/system.min.js"></script>
  <!-- 声明依赖模块路径 -->
  <script type="systemjs-importmap">
    {
      "imports": {
        "React": "https://gw.alipayobjects.com/os/lib/react/16.8.6/umd/react.production.min.js",
        "ReactDOM": "https://gw.alipayobjects.com/os/lib/react-dom/16.8.6/umd/react-dom.production.min.js"
      }
    }
  </script>
</head>
<body>
  <!-- <%= JSON.stringify(htmlWebpackPlugin, null, 2) %> -->
  <div class="__microfe-layout">
    <div class="__microfe-nav" id="__microfe-nav"></div>
    <div class="__microfe-body">
      <div class="__microfe-menu" id="__microfe-menu"></div>
      <div class="__microfe-main" id="__microfe-main"></div>
    </div>
    <style>
      body, html, p {
        margin: 0;
        padding: 0;
      }
      body, html {
        height: 100%;
      }
      .__microfe-layout {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      .__microfe-body {
        flex: 1;
        display: flex;
      }
      .__microfe-main {
        flex: 1;
      }
    </style>
  </div>
  <% for(let i = 0; i < bodies.length; i++) { %>
  <%= bodies[i] %>
  <% } %>
  <script>
    (async function(){
      var APP_MAP = <%= pages %>;
      var assets_url = "<%= assets_url %>";
      var React = (await System.import('React')).default;
      var ReactDOM = (await System.import('ReactDOM')).default;

      var elContent = document.querySelector('#__microfe-root-content');
      function createOrGetContainer(id) {
        var container = document.querySelector(id);
        if (!container) {
          container = document.createElement('div');
          container.id = id;
          elContent.appendChild(container);
        }
        return container;
      }

      function pathPrefix(prefix) {
        return function() {
          return window.location.hash.startsWith(prefix)
        };
      }

      function getLayoutAssets() {
        var hostname = window.location.hostname;
        <% if (debug) { %>
        var layoutAssets = {
          header: './header.js',
          menu: {
            boh: './boh-menu.js',
            crm: './crm-menu.js',
          },
        };
        <% } else { %>
        var layoutAssets = {
          header: 'https://g-assets.daily.taobao.net/SaasAppGroup/webappTest/1.0.0/header.js',
          menu: {
            boh: 'https://g-assets.daily.taobao.net/SaasAppGroup/webappTest/1.0.0/boh-menu.js',
            crm: 'https://g-assets.daily.taobao.net/SaasAppGroup/webappTest/1.0.0/crm-menu.js',
          },
        };
        <% } %>
        return layoutAssets;
      }

      var layoutAssets = getLayoutAssets();

      function registerApp(appName, app) {
        var _navContainer;
        var _menuContainer;
        var _mainContainer;
        singleSpa.registerApplication(appName, {
            bootstrap: function() {
              _navContainer = createOrGetContainer('#__microfe-nav');
              _menuContainer = createOrGetContainer('#__microfe-menu');
              _mainContainer = createOrGetContainer(app.container || '#__microfe-main');
              return Promise.resolve();
            },
            mount: async function() {
              if (app.header) {
                var _navComponent = (await System.import(layoutAssets.header)).default;
                ReactDOM.render(
                  React.createElement(_navComponent),
                  _navContainer,
                );
              }

              if (app.menu) {
                var _menuComponent = (await System.import(layoutAssets.menu[app.menu])).default;
                ReactDOM.render(
                  React.createElement(_menuComponent),
                  _menuContainer,
                );
              }

              if (appName) {
                var _mainComponent = (await System.import(assets_url + appName + '.js')).default;
                ReactDOM.render(
                  React.createElement(_mainComponent),
                  _mainContainer,
                );
              }
              return Promise.resolve();
            },
            unmount: function() {
              ReactDOM.unmountComponentAtNode(_navContainer);
              ReactDOM.unmountComponentAtNode(_menuContainer);
              ReactDOM.unmountComponentAtNode(_mainContainer);
              return Promise.resolve();
            },
          },
          pathPrefix('#' + app.route),
        );
      }

      // 注册APP
      Object.keys(APP_MAP).forEach(appName => {
        registerApp(appName, APP_MAP[appName]);
      });

      singleSpa.start();
    })()
  </script>
</body>

</html>